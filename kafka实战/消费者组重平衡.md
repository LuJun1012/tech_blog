# 消费者组重平衡

#### 重平衡通知
* 靠消费者的心跳线程
* 协调者将REBALANCE_IN_PROGRESS封装进心跳请求响应中发送给消费者

#### 消费者组状态机



|  | 消费者五种状态 |  |
| :-: | :-: | :-: |
| 状态 | 含义 |  |
| Empty | 组内没有任何成员，但消费者组可能存在已提交的位移数据，而且这些位移尚未过期  |  |
| Dead | 同样是组内没有任何成员，但组的元数据信息已经在协调者端被移除。协调者组件保存着当前向它注册过的所有组信息，所谓的元数据信息就类似于这个注册信息 |  |
| PreparingRebalance | 消费者组准备开启重平衡，此时所有成员都要重新请求加入消费者组 |  |
| CompletingRebalance | 消费者组下所有成员已经加入，各个成员正在等待分配方案。该状态在老一点的版本中被称为 Awaitingsync，它和 Completing Rebalancek 是等价的 |  |
| Stable | 消费者组的稳定状态。该状态表明重平衡已经完成，组内各成员能够正常消费数据了 |  |

* ![f16fbcb798a53c21c3bf1bcd5b72b006](media/15649249729413/f16fbcb798a53c21c3bf1bcd5b72b006.png)

#### 重平衡流程
* JoinGroup JoinGroup 请求的主要作用是将组成员订阅信息发送给领导者消费者，待领导者制定好分配方案后，重平衡流程进入到 SyncGroup 请求阶段
* SyncGroup 就是让协调者把领导者制定的分配方案下发给各个组内成员。当所有成员都成功接收到分配方案后，消费者组进入到 Stable 状态，即开始正常的消费工作

#### 重平衡场景
* 新成员入组
* 组成员离开组
* 组成员崩溃离组 session.timeout.ms
* 重平衡时协调者对组内成员提交位移的处理