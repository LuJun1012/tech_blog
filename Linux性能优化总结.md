# Linux性能优化总结
#### 性能问题的来源
* 资源瓶颈的分析思路，跟系统资源瓶颈是一样的。
* 依赖服务的瓶颈，可以使用全链路跟踪系统，进行快速定位。
* 应用自身的问题，则可以通过系统调用、热点函数，或者应用自身的指标和日志等，进行分析定位。

#### CPU优化
* 进程绑定CPU, 把进程绑定到一个或者多个 CPU 上，充分利用 CPU 缓存的本地性，并减少进程间的相互影响。
* 中断程序多CPU负载均衡，以便在发生大量中断时，可以充分利用多CPU的优势分摊负载。
* 使用 Cgroups 等方法，为进程设置资源限制，避免个别进程消耗过多的CPU。
* 为核心应用程序设置更高的优先级，减少低优先级任务的影响。

#### 内存优化
* 禁止Swap
* 使用 Cgroups 等方法，为进程设置内存限制
* 核心应用，还应该降低 oom_score，避免被OOM杀死

#### 磁盘和文件系统IO
* 使用SSD，使用RAID提升IO性能
* 选择合适的I/O调度算法，SSD和虚拟机磁盘使用Noop，数据库应用使用deadline算法
* 优化文件系统和磁盘的缓存和缓冲区

#### 网络优化
##### 内核资源和网络协议
* 增大套接字缓冲区、连接跟踪表、最大半连接数、最大文件描述符数、本地端口范围等内核资源配额
* 减少TIMEOUT超时时间、SYN+ACK 重传数、Keepalive 探测时间等异常处理参数
* 开启端口复用、反向地址校验，并调整 MTU 大小等降低内核的负担

##### 反向地址校验
* 就是在一个网卡收到数据包后，把源地址和目标地址对调后查找路由出口，从而得到反身后路由出口。然后根据反向路由出口进行过滤。
* 当rp_filter的值为1时，要求反向路由的出口必须与数据包的入口网卡是同一块，否则就会丢弃数据包。
* 当rp_filter的值为2时，要求反向路由必须是可达的，如果反路由不可达，则会丢弃数据包。

###### 作用
* 减少DDoS攻击
校验数据包的反向路径，如果反向路径不合适，则直接丢弃数据包，避免过多的无效连接消耗系统资源。
* 防止IP Spoofing
校验数据包的反向路径，如果客户端伪造的源IP地址对应的反向路径不在路由表中，或者反向路径不是最佳路径，则直接丢弃数据包，不会向伪造IP的客户端回复响应

#####网络接口
* CPU 上执行的工作，卸载到网卡中执行，开启网卡的 GRO、GSO、RSS、VXLAN 
* 开启网络接口的多队列功能，这样，每个队列就可以用不同的中断号，调度到不同 CPU 上执行
* 增大网络接口的缓冲区大小以及队列长度等，提升网络传输的吞吐量

##### 极限性能
* DPDK 技术，跳过内核协议栈，直接由用户态进程用轮询的方式，来处理网络请求
* 大页、CPU 绑定、内存对齐、流水线并发等多种机制，优化网络包的处理效率。
* 增大网络接口的缓冲区大小以及队列长度等，提升网络传输的吞吐量

#### 应用程序优化
* 从 CPU 使用的角度来说，简化代码、优化算法、异步处理以及编译器优化等，都是常用的降低 CPU 使用率的方法
* 数据访问的角度来说，使用缓存、写时复制、增加 I/O 尺寸等，都是常用的减少磁盘 I/O 的方法，
* 内存管理的角度来说，使用大页、内存池等方法，可以预先分配内存，减少内存的动态分配，从而更好地内存访问性能
* 网络的角度来说，使用 I/O 多路复用、长连接代替短连接、DNS 缓存等方法，可以优化网络 I/O 并减少网络请求数，从而减少网络延时带来的性能问题
* 从进程的工作模型来说，异步处理、多线程或多进程等，可以充分利用每一个 CPU 的处理能力，从而提高应用程序的吞吐能力
* 架构层面 消息队列、CDN、负载均衡等各种方法，来优化应用程序的架构，将原来单机要承担的任务，调度到多台服务器中并行处理

